var H=Object.defineProperty;var A=(t,e,s)=>e in t?H(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var C=(t,e,s)=>(A(t,typeof e!="symbol"?e+"":e,s),s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function s(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=s(n);fetch(n.href,i)}})();const S="192.168.2.2",u={getSystemInfo:async()=>{const{data:t}=await d({path:"/info/system"});return t||{}},getActions:async()=>{const{data:t}=await d({path:"/info/actions"});return t||[]},getConfigInfo:async()=>{const{data:t}=await d({path:"/info/config"});return t||{}},getWifiSettings:async()=>{const{data:t}=await d({path:"/wifi"});return t},saveWifiSettings:async({ssid:t,password:e,mode:s})=>{const{data:a}=await d({path:"/wifi",method:"POST",payload:{ssid:t,password:e}});return a},saveName:async t=>{const{status:e}=await d({path:"/info/system",method:"PUT",payload:{name:t}});return e!==200},performAction:async t=>{const{status:e}=await d({method:"PUT",path:"/actions",params:{action:t}});return e===200},getSensors:async()=>{const{data:t}=await d({path:"/sensors"});return t||{}},getStates:async()=>{const{data:t}=await d({path:"/states"});return t||{}},getConfigValues:async()=>{const{data:t}=await d({path:"/config"});return t||{}},deleteAllConfigValues:async()=>{const{status:t}=await d({method:"DELETE",path:"/config/delete/all"});return t===200},saveConfigValues:async t=>{const{status:e}=await d({method:"POST",path:"/config",payload:t});return e===200},getCallbacks:async({observable:{name:t,type:e}})=>{const{data:s}=await d({path:"/callback/by/observable",params:{name:t,type:e}});return s||[]},getCallbacksTemplates:async()=>{const{data:t}=await d({path:"/callback/template"});return t||[]},createCallback:async({observable:{name:t,type:e},callback:s})=>{const{status:a}=await d({path:"/callback",method:"POST",payload:{observable:{name:t,type:e},callback:s}});return a===201},updateCallback:async({observable:{name:t,type:e},callback:s})=>{const{status:a}=await d({path:"/callback",method:"PUT",payload:{observable:{name:t,type:e},callback:s}});return a===200},deleteCallback:async({observable:{name:t,type:e},id:s})=>{const{status:a}=await d({path:"/callback",method:"DELETE",params:{name:t,type:e,id:s}});return a===200},getMetrics:async()=>{const{data:t}=await d({path:"/metrics"});return t||{}}};function O(t){if(!t||!Object.keys(t))return"";const e=Object.entries(t).map(([s,a])=>`${s}=${a}`);return e.length>0?"?"+e.join("&"):""}function d({method:t="GET",path:e,payload:s,params:a}){let n=new XMLHttpRequest;n.open(t,`http://${S}${e[0]!="/"?"/":""}${e}${O(a)}`),n.setRequestHeader("Accept","application/json"),s&&n.setRequestHeader("Content-Type","application/json");let i;const l=new Promise(o=>i=o);return n.onreadystatechange=()=>{n.readyState===4&&i({data:n.response?JSON.parse(n.response):null,status:n.status})},n.send(s?JSON.stringify(s):null),l}const c={container:({bordered:t=!1})=>{const e=document.createElement("div");return t&&e.classList.add("bordered"),e},list:()=>{const t=document.createElement("div");return t.classList.add("list"),t},button:({id:t,label:e,labelElement:s="h3",onClick:a=()=>{},danger:n=!1,visible:i=!0})=>{const l=document.createElement("button");return t&&(l.id=t),l.innerHTML=`<${s}>${e}</${s}>`,l.onclick=a,n&&(l.style.backgroundColor="var(--color-danger)"),i||(l.style.display="None"),l},icon:({id:t,icon:e,onClick:s=()=>{},visible:a=!0})=>{const n=document.createElement("span");return t&&(n=t),n.classList.add("icon"),n.ariaHidden=!0,n.role="img",n.innerHTML=e,a||(n.style.display="None"),n.onclick=s,n},input:({id:t,label:e,value:s,disabled:a=!1,type:n="text",slot:i,props:l={}})=>{const o=document.createElement("div");o.classList.add("legit","field-container");const r=document.createElement("h2");r.classList.add("field-label"),r.innerHTML=e;const h=document.createElement("div");h.classList.add("input-with-slot");const p=document.createElement("input");return t&&(p.id=t),p.disabled=a,p.value=s,p.type=n,Object.entries(l).forEach(([m,f])=>p.setAttribute(m,f)),h.appendChild(p),i&&h.appendChild(i),o.append(r,h),o},combobox:({id:t,value:e,values:s,label:a,disabled:n=!1,onChange:i,props:l={}})=>{const o=document.createElement("div");if(o.classList.add("field-container"),a){const h=document.createElement("h2");h.classList.add("field-label"),h.innerHTML=a,o.appendChild(h)}const r=document.createElement("select");return t&&(r.id=t),r.disabled=n,r.appendChild(document.createElement("option")),i&&(r.onchange=()=>i(r.value)),Object.entries(l).forEach(([h,p])=>r.setAttribute(h,p)),o.append(r),T(o,s),e&&(r.value=e),o},tree:t=>{const e=document.createElement("ul");return Object.entries(t).forEach(([s,a])=>e.appendChild(_({key:s,value:a}))),e},controlsHolder:()=>{const t=document.createElement("div");return t.classList.add("controls-holder"),t}},b={pencil:'<svg fill="currentColor" class="material-design-icon__svg" width="35" height="35" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"><!----></path></svg>',trash:'<svg fill="currentColor" class="material-design-icon__svg" width="35" height="35" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"><!----></path></svg>',cross:'<svg fill="currentColor" class="material-design-icon__svg" width="35" height="35" viewBox="0 0 24 24"><path d="M13.46,12L19,17.54V19H17.54L12,13.46L6.46,19H5V17.54L10.54,12L5,6.46V5H6.46L12,10.54L17.54,5H19V6.46L13.46,12Z"><!----></path></svg>',save:'<svg fill="currentColor" class="material-design-icon__svg" width="35" height="35" viewBox="0 0 24 24"><path d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"><!----></path></svg>'};function T(t,e){if(!e)return;const s=t.getElementsByTagName("select")[0];if(!s){console.error("Can't find select in combobox");return}let a;Array.isArray(e)?a=e.map(n=>({key:n,caption:n})):a=Object.entries(e).map(([n,i])=>({key:n,caption:i})),a.forEach(({key:n,caption:i})=>{const l=document.createElement("option");l.value=n,l.innerHTML=i,s.appendChild(l)})}const _=({key:t,value:e})=>{const s=document.createElement("li");return s.append(t+": ",M(e)),s},M=t=>{if(Array.isArray(t)){const e=document.createElement("ul");return t.forEach(s=>{const a=document.createElement("li");a.innerHTML=s,e.appendChild(a)}),e}else if(t instanceof Object){const e=document.createElement("ul");return Object.entries(t).forEach(([s,a])=>{const n=document.createElement("li");n.appendChild(_({key:s,value:a})),e.appendChild(n)}),e}else{const e=document.createElement("span");return e.innerHTML=t,e}};function y(t){return typeof t!="string"||t.length==0?"":t.split("").reduce((e,s)=>(s==="_"?e+=" ":s===s.toUpperCase()?e+=" "+s.toLowerCase():e+=s,e),"")}const I=["id","type","readonly"];function $(t){return I.includes(t)}class E{constructor({id:e="",callback:s,template:a,observable:n,parent:i}){this.id=e,this.callback=s,this.template=a,this.observable=n,this.parent=i,this.fields=Object.entries(this.callback).filter(([l,o])=>!$(l)).reverse(),this.controls={delete:c.icon({icon:b.trash,onClick:()=>this.delete()}),edit:c.icon({icon:b.pencil,onClick:()=>this.edit()}),cancel:c.icon({icon:b.cross,onClick:()=>this.cancel(),visible:!1}),save:c.icon({icon:b.save,onClick:()=>this.save(),visible:!1})}}create(){const e=document.getElementById(this.id);if(this.id&&e)return e;const s=c.container({bordered:!0});s.id=this.id;const a=document.createElement("div");a.classList.add("callback-header");const n=document.createElement("h3"),{id:i,caption:l,type:o}=this.callback;n.innerHTML=`[${i}] ${l||y(o)}`,n.classList.add("title","callback-title");const r=document.createElement("div");r.classList.add("callback-view-controls"),Object.values(this.controls).forEach(p=>r.appendChild(p)),a.append(n,r);const h=c.list();return this.fields.forEach(([p,m])=>{const{required:f}=this.template[p]||!1,w={id:`cb_${i}_${p}`,label:y(p),value:m,disabled:!0,props:{required:f}};let v;this.template[p]&&this.template[p].values?v=c.combobox({...w,values:this.template[p].values}):v=c.input(w),h.appendChild(v)}),s.append(a,h),s}edit(e=!0){this.fields.forEach(([s,a])=>{document.getElementById(`cb_${this.callback.id}_${s}`).disabled=!e}),e?(this.controls.cancel.style.display="",this.controls.save.style.display="",this.controls.delete.style.display="None",this.controls.edit.style.display="None"):(this.controls.cancel.style.display="None",this.controls.save.style.display="None",this.controls.delete.style.display="",this.controls.edit.style.display="")}validate(){let e=!0;return this.fields.forEach(([s,a])=>{const n=document.getElementById(`cb_${this.callback.id}_${s}`);n.getAttribute("required")=="true"&&!n.value&&(e=!1,n.classList.add("required"))}),e}async save(){if(!this.validate())return;this.fields.forEach(([s,a])=>{this.callback[s]=document.getElementById(`cb_${this.callback.id}_${s}`).value});let e;this.callback.id==="New"?e=await u.createCallback({observable:this.observable,callback:this.callback}):e=await u.updateCallback({observable:this.observable,callback:this.callback}),e&&(document.getElementById(this.id).remove(),this.parent.update())}async delete(){confirm("Are you sure you wan to delete callback "+this.callback.id+"?")&&await u.deleteCallback({observable:this.observable,id:this.callback.id})&&this.parent.update()}cancel(){this.callback.id==="New"?(document.getElementById(this.id).remove(),this.parent.update()):this.edit(!1)}}class L{constructor({id:e="",observable:s}){this.id=e,this.observable=s}create(){const e=document.getElementById(this.id);if(this.id&&e)return e;const s=document.createElement("div");return s.id=this.id,this.comboboxTemplates=c.combobox({values:[],label:"Add callback of type",onChange:a=>{this.addNewCallback(a)}}),this.list=c.list(),this.list.id="cb_list_"+this.id,this.list.classList.add("callbacks-list-view"),s.append(this.comboboxTemplates,this.list),this.firstLoad(),s}update(){this.loadCallbacks()}async firstLoad(){await this.loadTemplates(),this.loadCallbacks()}async loadTemplates(){this.templates=await u.getCallbacksTemplates(),T(this.comboboxTemplates,Object.keys(this.templates).filter(e=>e!=="default").reduce((e,s)=>(e[s]=y(s),e),{}))}async loadCallbacks(){if(this.list.innerHTML="",this.callbacks=void 0,this.callbacks=await u.getCallbacks({observable:this.observable}),!this.callbacks||this.callbacks.length===0){this.list.innerHTML="<h3 class='title'>No callbacks yet added</h3>";return}this.callbacks.forEach(e=>this.list.appendChild(new E({id:"cb_"+e.id,callback:e,template:this.templates[e.type],observable:this.observable,parent:this}).create()))}addNewCallback(e){const s=document.getElementById("cb_new");if(s&&s.remove(),!e)return;const a={...this.templates[e],...this.templates.default},n=Object.entries(a).reduce((l,[o,r])=>(l[o]=r.default||"",l),{id:"New",type:e}),i=new E({id:"cb_new",callback:n,template:a,observable:this.observable,parent:this});this.list.prepend(i.create()),i.edit()}}class g{constructor(e,s){C(this,"selectedTab",{});this.id=e,this.tabs=s}create(){const e=document.createElement("div");return e.classList.add("tabs-panel"),this.viewDiv=document.createElement("div"),this.viewDiv.classList.add("tabs-items","list"),this.viewDiv.id=this.id,Object.entries(this.tabs).forEach(([s,{name:a}])=>{const n=document.createElement("h2");n.id=s,n.innerHTML=a,n.onclick=()=>this.open(s),this.viewDiv.appendChild(n)}),this.contentDiv=document.createElement("div"),this.contentDiv.classList.add("tabs-content"),this.contentDiv.id=this.id+"_content",e.append(this.viewDiv,this.contentDiv),e}open(e){const s=document.getElementById(e);if(!s){console.error("Failed to open tab id="+e+": element not found");return}this.selectedTab.tab&&(this.selectedTab.tab.classList.remove("selected-tab"),this.selectedTab.content.style.display="None");let a=document.getElementById(e+"_content");a||(a=this.createTabContent(e),this.contentDiv.appendChild(a)),s.classList.add("selected-tab"),a.style.display="",this.selectedTab.tab=s,this.selectedTab.content=a}createTabContent(e){const s=e+"_content",a=document.createElement("div");if(a.id=s,a.classList.add("tab-content"),a.style.display="None",this.tabs[e].title){const n=document.createElement("h1");n.classList.add("title"),n.innerHTML=this.tabs[e].title,a.appendChild(n)}return this.loadContent(a,e),a}async loadContent(e,s){try{e.appendChild(await this.tabs[s].content())}catch(a){console.error(a)}}}const D={info:{name:"Information",title:"Device information",content:async()=>{const t=await u.getSystemInfo(),e=c.list();return e.append(c.input({id:"name",label:"Device name",value:t.name||"",slot:c.button({label:"save",onClick:()=>u.saveName(document.getElementById("name").value)})}),c.input({label:"Device type",value:t.type,disabled:!0}),c.input({label:"Firmware version",value:t.version,disabled:!0,type:"number"}),c.input({label:"Chip model",value:t.chip_model,disabled:!0}),c.input({label:"Chip revision",value:t.chip_revision,disabled:!0})),e}},wifi:{name:"WiFi",title:"WiFi settings",content:async()=>{const{settings:t,modes:e}=await u.getWifiSettings(),s=c.list();s.append(c.input({id:"ssid",label:"SSID",value:t.ss||""}),c.input({id:"password",label:"password",value:t.ps||""}),c.combobox({id:"mode",label:"mode",values:e,value:t.mode}));const a=c.controlsHolder();a.appendChild(c.button({label:"Save and reconnect",onClick:async()=>await u.saveWifiSettings({ssid:document.getElementById("ssid").value||"",password:document.getElementById("password").value||"",mode:document.getElementById("mode").value||""})}));const n=document.createElement("div");return n.append(s,a),n}},actions:{name:"Actions",title:"Device actions",content:async()=>{const t=await u.getActions(),e=c.list();return Object.entries(t).forEach(([s,a])=>{e.appendChild(c.button({id:"action_"+s,label:a,labelElement:"h1",onClick:()=>u.performAction(s)}))}),e}},sensors:{name:"Sensors",title:"Sensors values",content:async()=>{const t=await u.getSensors(),e=Object.entries(t).reduce((a,[n,{value:i,type:l}])=>(a["sensors_tab_"+n]={name:`${n} (${l}): ${i}`,title:"Callbacks",content:async()=>new L({id:"cb_view_"+n,observable:{type:"sensor",name:n}}).create()},a),{});return new g("sensors",e).create()}},states:{name:"States",title:"Device states",content:async()=>{const t=await u.getStates(),e=Object.entries(t).reduce((a,[n,i])=>(a["state_tab_"+n]={name:`${n}: ${i}`,title:"Callbacks",content:async()=>new L({id:"cb_view_"+n,observable:{type:"state",name:n}}).create()},a),{});return new g("states",e).create()}},configuration:{name:"Configuration",title:"Configuration",content:async()=>{const t=await u.getConfigInfo(),e=await u.getConfigValues(),s=c.list();Object.entries(t).forEach(([i,{caption:l,type:o}])=>{s.appendChild(c.input({id:i,label:l,type:o,value:e[i]||""}))});const a=c.controlsHolder();a.append(c.button({label:"Delete all values",danger:!0,labelElement:"h2",onClick:()=>{confirm("Are you sure you want to delete all configuration values?")&&u.deleteAllConfigValues()}}),c.button({label:"Save",labelElement:"h2",onClick:()=>u.saveConfigValues()}));const n=document.createElement("div");return n.append(s,a),n}},metrics:{name:"Metrics",title:"Device metrics",content:async()=>{const t=await u.getMetrics();return c.tree(t)}}},k=new g("tabs-main",D);window.onload=()=>{document.getElementById("control-panel").appendChild(k.create()),k.open("states")};
